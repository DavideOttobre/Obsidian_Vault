# ðŸ“œ 5.3 API e Fetch avanzato

## Introduzione

Abbiamo giÃ  visto come usare `fetch()` per ottenere dati da un server. Ora vedremo come:  
âœ… Inviare richieste avanzate con `headers` e `POST`.  
âœ… Gestire **autenticazione con token**.  
âœ… Intercettare errori di rete e HTTP.

---

## ðŸ”¹ 1. Usare `fetch()` con opzioni avanzate

Oltre alla richiesta base, possiamo personalizzare `fetch()` con opzioni come:  
âœ… Metodo (`GET`, `POST`, `PUT`, `DELETE`).  
âœ… Headers per autenticazione o JSON.  
âœ… Corpo della richiesta (`body`) per inviare dati.

---

### âœ… **Esempio: Richiesta `POST` con JSON**

```js
fetch("https://jsonplaceholder.typicode.com/posts", {
    method: "POST",
    headers: {
        "Content-Type": "application/json",
        "Authorization": "Bearer TOKEN"
    },
    body: JSON.stringify({
        titolo: "Nuovo Post",
        contenuto: "Testo del post"
    })
})
.then(response => response.json())
.then(data => console.log("Dati ricevuti:", data))
.catch(error => console.error("Errore:", error));
```

ðŸ“Œ **Dettagli importanti:**  
âœ… `method: "POST"` indica che stiamo inviando dati.  
âœ… `headers` definisce il formato della richiesta (`JSON`) e lâ€™autenticazione.  
âœ… `body` contiene i dati in formato JSON.

---

## ðŸ”¹ 2. Gestire errori di rete e server

Se un server risponde con un errore (`404 Not Found` o `500 Internal Server Error`), `fetch()` **non lo considera un errore di default**.

ðŸ“Œ **Gestiamo manualmente gli errori HTTP:**

```js
fetch("https://jsonplaceholder.typicode.com/todos/123456") // URL errato
    .then(response => {
        if (!response.ok) {
            throw new Error(`Errore HTTP: ${response.status}`);
        }
        return response.json();
    })
    .then(data => console.log("Dati:", data))
    .catch(error => console.error("Errore:", error.message));
```

âœ… **Ora possiamo gestire errori HTTP come `404` o `500`.**

---

## ðŸ”¹ 3. Autenticazione con `fetch()` e token

Molte API richiedono un **token di autenticazione** (`Bearer Token`).

### âœ… **Esempio: Autenticazione con Token**

```js
fetch("https://api.example.com/protected-data", {
    method: "GET",
    headers: {
        "Authorization": "Bearer il_tuo_token"
    }
})
.then(response => response.json())
.then(data => console.log("Dati protetti:", data))
.catch(error => console.error("Errore:", error));
```

ðŸ“Œ **Il token viene passato nellâ€™`Authorization` header.**

---

## ðŸ”¹ 4. Usare `async/await` per richieste API

Per rendere il codice piÃ¹ leggibile, usiamo `async/await`.

### âœ… **Esempio con `async/await`**

```js
async function getDati() {
    try {
        let response = await fetch("https://jsonplaceholder.typicode.com/todos/1");

        if (!response.ok) {
            throw new Error(`Errore HTTP: ${response.status}`);
        }

        let data = await response.json();
        console.log("Dati ricevuti:", data);
    } catch (error) {
        console.error("Errore:", error.message);
    }
}

getDati();
```

ðŸ“Œ **Vantaggi di `async/await`:**  
âœ… **PiÃ¹ leggibile** rispetto alle Promises.  
âœ… **Gestisce gli errori con `try...catch`**.

---

## ðŸ”¹ 5. Effettuare piÃ¹ richieste contemporaneamente

Usiamo `Promise.all()` per eseguire piÃ¹ richieste in parallelo.

### âœ… **Esempio: Ottenere piÃ¹ risorse contemporaneamente**

```js
async function getMultipli() {
    try {
        let [utente, post] = await Promise.all([
            fetch("https://jsonplaceholder.typicode.com/users/1").then(res => res.json()),
            fetch("https://jsonplaceholder.typicode.com/posts/1").then(res => res.json())
        ]);

        console.log("Utente:", utente);
        console.log("Post:", post);
    } catch (error) {
        console.error("Errore:", error.message);
    }
}

getMultipli();
```

ðŸ“Œ **Riduce il tempo di attesa eseguendo piÃ¹ richieste in parallelo.**

---

## ðŸ”¹ 6. Cancellare una richiesta `fetch()` con `AbortController`

Se una richiesta richiede troppo tempo, possiamo **annullarla**.

### âœ… **Esempio: Timeout automatico per `fetch()`**

```js
const controller = new AbortController();
const signal = controller.signal;

setTimeout(() => controller.abort(), 3000); // Annulla la richiesta dopo 3 secondi

fetch("https://jsonplaceholder.typicode.com/todos/1", { signal })
    .then(response => response.json())
    .then(data => console.log("Dati ricevuti:", data))
    .catch(error => console.error("Errore:", error.name)); // AbortedError se annullata
```

ðŸ“Œ **Perfetto per timeout su richieste lente!**

---

## ðŸ“Œ **Riepilogo**

|Metodo|Descrizione|
|---|---|
|`fetch(url)`|Esegue una richiesta HTTP GET|
|`fetch(url, { method: "POST", body: JSON.stringify(dati) })`|Esegue una richiesta POST con dati|
|`.then(response => response.json())`|Converte la risposta in JSON|
|`.catch(error => console.error(error))`|Gestisce errori di rete|
|`async/await`|Alternativa piÃ¹ leggibile alle Promises|
|`Promise.all([fetch1, fetch2])`|Esegue piÃ¹ richieste contemporaneamente|
|`AbortController`|Annulla una richiesta `fetch()`|

---

## Collegamenti utili

- **Prossimo argomento â†’ [[5.4 WebSockets]]**
- **Ripassa Web Storage â†’ [[5.2 Web Storage (localStorage e sessionStorage)]]**

---

# ðŸ“œ 5.4 WebSockets

## Introduzione

I **WebSockets** permettono di creare una comunicazione **bidirezionale** tra client e server **in tempo reale**.

ðŸ“Œ **PerchÃ© usare WebSockets?**  
âœ… Permettono **aggiornamenti live** senza ricaricare la pagina.  
âœ… Sono piÃ¹ efficienti di AJAX e Fetch per comunicazioni continue.  
âœ… Usati in **chat, notifiche push, giochi online** e dati in streaming.

---

## ðŸ”¹ 1. Creare una connessione WebSocket

Il metodo `new WebSocket(url)` permette di aprire una connessione con un server WebSocket.

### âœ… **Esempio base di WebSocket**

```js
let socket = new WebSocket("wss://echo.websocket.org");

// Evento quando la connessione Ã¨ aperta
socket.addEventListener("open", () => {
    console.log("Connessione aperta!");
    socket.send("Ciao server!");
});

// Evento quando si riceve un messaggio
socket.addEventListener("message", (evento) => {
    console.log("Messaggio ricevuto:", evento.data);
});

// Evento quando la connessione si chiude
socket.addEventListener("close", () => {
    console.log("Connessione chiusa.");
});

// Evento quando c'Ã¨ un errore
socket.addEventListener("error", (errore) => {
    console.error("Errore WebSocket:", errore);
});
```

ðŸ“Œ **Spiegazione:**  
âœ… `open` â†’ Si attiva quando la connessione Ã¨ stabilita.  
âœ… `message` â†’ Si attiva quando arriva un messaggio dal server.  
âœ… `close` â†’ Si attiva quando la connessione viene chiusa.  
âœ… `error` â†’ Si attiva in caso di errore.

---

## ðŸ”¹ 2. Inviare e ricevere dati con WebSockets

Possiamo inviare messaggi con `socket.send()`.

### âœ… **Esempio di invio e ricezione di un messaggio**

```js
let socket = new WebSocket("wss://echo.websocket.org");

socket.addEventListener("open", () => {
    socket.send("Ciao!"); // Invia un messaggio al server
});

socket.addEventListener("message", (evento) => {
    console.log("Risposta dal server:", evento.data);
});
```

ðŸ“Œ **Il server risponde con lo stesso messaggio inviato (`echo`).**

---

## ðŸ”¹ 3. Chiudere una connessione WebSocket

Possiamo chiudere manualmente la connessione con `socket.close()`.

### âœ… **Esempio di chiusura della connessione**

```js
socket.close();
```

ðŸ“Œ **Dopo `close()`, la connessione non puÃ² piÃ¹ essere usata.**

---

## ðŸ”¹ 4. Riconnettere WebSockets automaticamente

Se il WebSocket si chiude, possiamo riaprire automaticamente la connessione.

### âœ… **Esempio di riconnessione automatica**

```js
function connetti() {
    let socket = new WebSocket("wss://echo.websocket.org");

    socket.addEventListener("close", () => {
        console.log("Connessione persa. Riconnessione...");
        setTimeout(connetti, 3000); // Riprova dopo 3 secondi
    });

    socket.addEventListener("open", () => {
        console.log("Connessione stabilita!");
    });
}

connetti();
```

ðŸ“Œ **Perfetto per chat o app che devono rimanere sempre connesse.**

---

## ðŸ”¹ 5. WebSockets con JSON

I WebSockets possono inviare **oggetti JSON**, utili per strutturare i dati.

### âœ… **Esempio con JSON**

```js
let socket = new WebSocket("wss://echo.websocket.org");

socket.addEventListener("open", () => {
    let messaggio = { utente: "Alice", testo: "Ciao a tutti!" };
    socket.send(JSON.stringify(messaggio)); // Invia JSON
});

socket.addEventListener("message", (evento) => {
    let dati = JSON.parse(evento.data); // Converte da JSON
    console.log("Messaggio ricevuto:", dati);
});
```

ðŸ“Œ **`JSON.stringify()` converte in stringa prima di inviare, `JSON.parse()` converte in oggetto quando riceviamo.**

---

## ðŸ“Œ **Riepilogo**

|Metodo|Descrizione|
|---|---|
|`new WebSocket(url)`|Crea una nuova connessione WebSocket|
|`socket.send(data)`|Invia un messaggio al server|
|`socket.close()`|Chiude la connessione WebSocket|
|`socket.addEventListener("open", function)`|Evento quando la connessione Ã¨ aperta|
|`socket.addEventListener("message", function)`|Evento quando arriva un messaggio|
|`socket.addEventListener("close", function)`|Evento quando la connessione viene chiusa|
|`socket.addEventListener("error", function)`|Evento quando si verifica un errore|

---

## Collegamenti utili

- **Prossimo argomento â†’ [[6.1 Introduzione a Node.js]]**
- **Ripassa API e Fetch avanzato â†’ [[5.3 API e Fetch avanzato]]**

---
